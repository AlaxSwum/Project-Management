<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Focus</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --font: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
      --primary: #6366f1;
      --primary-light: #a5b4fc;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --blue: #3b82f6;
      --purple: #8b5cf6;
      --pink: #ec4899;
      --text: #1e293b;
      --text-2: #475569;
      --text-3: #94a3b8;
      --bg: rgba(255, 255, 255, 0.95);
      --card: #f8fafc;
      --card-hover: #f1f5f9;
      --border: rgba(0, 0, 0, 0.08);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --text: #f1f5f9;
        --text-2: #cbd5e1;
        --text-3: #64748b;
        --bg: rgba(15, 23, 42, 0.98);
        --card: rgba(30, 41, 59, 0.9);
        --card-hover: rgba(51, 65, 85, 0.9);
        --border: rgba(255, 255, 255, 0.1);
      }
    }

    body {
      font-family: var(--font);
      background: transparent;
      -webkit-font-smoothing: antialiased;
    }

    .app {
      margin: 8px;
      height: calc(100vh - 16px);
      background: var(--bg);
      backdrop-filter: blur(60px) saturate(200%);
      -webkit-backdrop-filter: blur(60px) saturate(200%);
      border-radius: 20px;
      border: 1px solid var(--border);
      box-shadow: 0 25px 60px -12px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      animation: pop 0.2s ease-out;
    }

    @keyframes pop {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    /* Header */
    .header {
      padding: 18px 18px 14px;
      border-bottom: 1px solid var(--border);
      -webkit-app-region: drag;
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      width: 42px;
      height: 42px;
      background: linear-gradient(135deg, var(--primary), var(--purple));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }

    .logo svg { width: 22px; height: 22px; color: white; }

    .brand-info h1 {
      font-size: 17px;
      font-weight: 700;
      color: var(--text);
    }

    .brand-info p {
      font-size: 12px;
      color: var(--text-3);
    }

    .close {
      width: 26px;
      height: 26px;
      border-radius: 8px;
      background: var(--card);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-app-region: no-drag;
      transition: all 0.15s;
    }

    .close:hover { background: rgba(239, 68, 68, 0.15); }
    .close svg { width: 12px; height: 12px; color: var(--text-3); }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 14px;
      background: var(--card);
      border-radius: 10px;
      padding: 4px;
      -webkit-app-region: no-drag;
    }

    .tab {
      flex: 1;
      padding: 8px 12px;
      border: none;
      background: transparent;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-3);
      cursor: pointer;
      transition: all 0.15s;
    }

    .tab:hover {
      color: var(--text-2);
    }

    .tab.active {
      background: white;
      color: var(--primary);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    @media (prefers-color-scheme: dark) {
      .tab.active {
        background: rgba(99, 102, 241, 0.2);
        color: var(--primary-light);
      }
    }

    /* Stats Row */
    .stats {
      display: flex;
      gap: 8px;
    }

    .stat {
      flex: 1;
      background: var(--card);
      border-radius: 10px;
      padding: 10px 8px;
      text-align: center;
    }

    .stat-val {
      font-size: 22px;
      font-weight: 700;
      color: var(--primary);
    }

    .stat-val.r { color: var(--danger); }
    .stat-val.b { color: var(--blue); }
    .stat-val.g { color: var(--success); }

    .stat-lbl {
      font-size: 9px;
      font-weight: 600;
      color: var(--text-3);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-top: 2px;
    }

    /* Content */
    .content {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }

    .content::-webkit-scrollbar { width: 4px; }
    .content::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    /* Section */
    .section {
      margin-bottom: 16px;
    }

    .section-title {
      font-size: 11px;
      font-weight: 700;
      color: var(--text-3);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 8px 4px 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .section-title.now {
      color: var(--danger);
    }

    .section-title.now::before {
      content: '';
      width: 6px;
      height: 6px;
      background: var(--danger);
      border-radius: 50%;
      animation: blink 1s ease-in-out infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    /* Task Card */
    .task {
      background: var(--card);
      border-radius: 12px;
      padding: 12px 14px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: all 0.15s;
      border-left: 3px solid transparent;
    }

    .task:hover {
      background: var(--card-hover);
      transform: translateX(2px);
    }

    .task.meeting { border-left-color: var(--danger); background: rgba(239, 68, 68, 0.06); }
    .task.routine { border-left-color: var(--success); background: rgba(16, 185, 129, 0.06); }
    .task.work { border-left-color: var(--blue); background: rgba(59, 130, 246, 0.06); }
    .task.personal { border-left-color: var(--purple); background: rgba(139, 92, 246, 0.06); }
    .task.social { border-left-color: var(--pink); background: rgba(236, 72, 153, 0.06); }

    .task.done {
      opacity: 0.5;
    }

    .task.done .task-title {
      text-decoration: line-through;
      color: var(--text-3);
    }

    .task.past:not(.done) {
      opacity: 0.7;
    }

    /* Checkbox */
    .chk {
      width: 20px;
      height: 20px;
      border-radius: 6px;
      border: 2px solid var(--border);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.15s;
    }

    .chk:hover {
      border-color: var(--success);
      background: rgba(16, 185, 129, 0.1);
    }

    .chk svg {
      width: 12px;
      height: 12px;
      color: white;
      opacity: 0;
    }

    .task.done .chk {
      background: var(--success);
      border-color: var(--success);
    }

    .task.done .chk svg { opacity: 1; }

    .task-body { flex: 1; min-width: 0; }

    .task-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .task-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .task-time {
      font-size: 11px;
      font-weight: 500;
      color: var(--text-2);
      white-space: nowrap;
    }

    .task-meta {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
    }

    .tag {
      font-size: 9px;
      font-weight: 700;
      text-transform: uppercase;
      padding: 3px 6px;
      border-radius: 4px;
      background: rgba(99, 102, 241, 0.1);
      color: var(--primary);
    }

    .tag.meeting { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
    .tag.routine { background: rgba(16, 185, 129, 0.1); color: var(--success); }
    .tag.work { background: rgba(59, 130, 246, 0.1); color: var(--blue); }
    .tag.personal { background: rgba(139, 92, 246, 0.1); color: var(--purple); }
    .tag.social { background: rgba(236, 72, 153, 0.1); color: var(--pink); }

    .duration {
      font-size: 10px;
      color: var(--text-3);
    }

    /* Skip button */
    .skip-btn {
      padding: 4px 8px;
      font-size: 10px;
      font-weight: 600;
      border: none;
      border-radius: 4px;
      background: rgba(245, 158, 11, 0.1);
      color: var(--warning);
      cursor: pointer;
      transition: all 0.15s;
      white-space: nowrap;
    }

    .skip-btn:hover {
      background: rgba(245, 158, 11, 0.2);
    }

    .task.skipped {
      opacity: 0.5;
      background: rgba(245, 158, 11, 0.05) !important;
      border-left-color: var(--warning) !important;
    }

    .task.skipped .task-title {
      text-decoration: line-through;
      color: var(--text-3);
    }

    .tag.skipped {
      background: rgba(245, 158, 11, 0.1);
      color: var(--warning);
    }

    /* Skip Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.15s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal {
      background: var(--bg);
      border-radius: 16px;
      padding: 20px;
      width: 90%;
      max-width: 320px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.2s ease-out;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .modal h3 {
      font-size: 16px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 8px;
    }

    .modal p {
      font-size: 12px;
      color: var(--text-3);
      margin-bottom: 16px;
    }

    .modal textarea {
      width: 100%;
      padding: 12px;
      font-size: 13px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--card);
      color: var(--text);
      resize: none;
      font-family: inherit;
      margin-bottom: 16px;
    }

    .modal textarea:focus {
      outline: none;
      border-color: var(--warning);
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
    }

    .modal-btn {
      flex: 1;
      padding: 10px;
      font-size: 13px;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .modal-btn.cancel {
      background: var(--card);
      color: var(--text-2);
    }

    .modal-btn.cancel:hover {
      background: var(--card-hover);
    }

    .modal-btn.skip {
      background: linear-gradient(135deg, var(--warning), #d97706);
      color: white;
    }

    .modal-btn.skip:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
    }

    /* Empty */
    .empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      text-align: center;
    }

    .empty-icon {
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, var(--success), #34d399);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 12px;
    }

    .empty-icon svg { width: 28px; height: 28px; color: white; }
    .empty h3 { font-size: 15px; font-weight: 700; color: var(--text); }
    .empty p { font-size: 12px; color: var(--text-3); margin-top: 4px; }

    /* Footer */
    .footer { padding: 10px 18px 14px; }

    .btn {
      width: 100%;
      font-size: 13px;
      font-weight: 600;
      padding: 12px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      background: linear-gradient(135deg, var(--primary), var(--purple));
      color: white;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.35);
      transition: all 0.15s;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(99, 102, 241, 0.45);
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
    }

    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="header-top">
        <div class="brand">
          <div class="logo">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M12 6v6l4 2"></path>
            </svg>
          </div>
          <div class="brand-info">
            <h1>Today's Schedule</h1>
            <p id="dateText"></p>
          </div>
        </div>
        <button class="close" onclick="closeView()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <path d="M18 6L6 18M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" data-tab="upcoming" onclick="switchTab('upcoming')">Upcoming</button>
        <button class="tab" data-tab="completed" onclick="switchTab('completed')">Completed</button>
      </div>
      
      <div class="stats">
        <div class="stat">
          <div class="stat-val" id="totalCount">0</div>
          <div class="stat-lbl">Total</div>
        </div>
        <div class="stat">
          <div class="stat-val r" id="meetingCount">0</div>
          <div class="stat-lbl">Meetings</div>
        </div>
        <div class="stat">
          <div class="stat-val b" id="blockCount">0</div>
          <div class="stat-lbl">Blocks</div>
        </div>
        <div class="stat">
          <div class="stat-val g" id="doneCount">0</div>
          <div class="stat-lbl">Done</div>
        </div>
      </div>
    </div>

    <div class="content" id="content">
      <div class="loading"><div class="spinner"></div></div>
    </div>

    <div class="footer">
      <button class="btn" onclick="openApp()">Open Full Schedule</button>
    </div>
  </div>

  <!-- Skip Modal -->
  <div class="modal-overlay" id="skipModal" style="display: none;">
    <div class="modal">
      <h3>Skip Task</h3>
      <p id="skipTaskName">Why are you skipping this task?</p>
      <textarea id="skipReason" rows="3" placeholder="Enter reason (optional)..."></textarea>
      <div class="modal-buttons">
        <button class="modal-btn cancel" onclick="closeSkipModal()">Cancel</button>
        <button class="modal-btn skip" onclick="confirmSkip()">Skip Task</button>
      </div>
    </div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');

    let tasks = [];
    let localDone = new Set();
    let localSkipped = new Map(); // Map of taskId -> { reason, skippedAt }
    let currentTab = 'upcoming';
    let skipTargetTask = null;

    const now = new Date();
    const todayStr = now.toISOString().split('T')[0];
    const currentHour = now.getHours();
    const currentMin = now.getMinutes();

    document.getElementById('dateText').textContent = now.toLocaleDateString('en-US', { 
      weekday: 'long', month: 'short', day: 'numeric' 
    });

    // Load tasks
    ipcRenderer.invoke('get-tasks').then(t => { tasks = t || []; render(); });
    ipcRenderer.on('tasks-updated', (e, t) => { tasks = t || []; render(); });

    // Refresh every 5 seconds
    setInterval(() => {
      ipcRenderer.invoke('get-tasks').then(t => { if (t) { tasks = t; render(); } });
    }, 5000);

    // Server refresh every 30 seconds
    setInterval(() => ipcRenderer.send('quickview-action', { action: 'refresh' }), 30000);

    function switchTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab').forEach(t => {
        t.classList.toggle('active', t.dataset.tab === tab);
      });
      render();
    }

    function fmt(t) {
      if (!t) return '';
      const [h, m] = t.split(':').map(Number);
      return `${h % 12 || 12}:${String(m || 0).padStart(2, '0')} ${h >= 12 ? 'PM' : 'AM'}`;
    }

    function getTaskMinutes(task) {
      if (!task.startTime) return 24 * 60; // End of day for tasks without time
      const [h, m] = task.startTime.split(':').map(Number);
      return h * 60 + m;
    }

    function render() {
      const content = document.getElementById('content');
      const nowMinutes = currentHour * 60 + currentMin;
      
      // Filter today's tasks only
      const todayTasks = tasks.filter(t => {
        const d = (t.date || t.deadline || t.startDate || '').split('T')[0];
        return d === todayStr;
      });

      // Count stats
      const meetings = todayTasks.filter(t => t.type === 'meeting');
      const blocks = todayTasks.filter(t => t.type === 'timeblock');
      const completed = todayTasks.filter(t => t.completed || localDone.has(String(t.id)));

      document.getElementById('totalCount').textContent = todayTasks.length;
      document.getElementById('meetingCount').textContent = meetings.length;
      document.getElementById('blockCount').textContent = blocks.length;
      document.getElementById('doneCount').textContent = completed.length;

      // Filter based on current tab
      let filteredTasks;
      if (currentTab === 'upcoming') {
        // Upcoming: not completed and not passed (or within current hour)
        filteredTasks = todayTasks.filter(t => {
          const isDone = t.completed || localDone.has(String(t.id));
          if (isDone) return false;
          const taskMin = getTaskMinutes(t);
          // Include tasks that haven't ended yet (give 30 min buffer after start)
          return taskMin >= nowMinutes - 30;
        });
      } else {
        // Completed: done or passed
        filteredTasks = todayTasks.filter(t => {
          const isDone = t.completed || localDone.has(String(t.id));
          const taskMin = getTaskMinutes(t);
          return isDone || taskMin < nowMinutes - 30;
        });
      }

      // Sort
      filteredTasks.sort((a, b) => {
        const ta = a.startTime || '23:59';
        const tb = b.startTime || '23:59';
        if (currentTab === 'completed') {
          return tb.localeCompare(ta); // Reverse for completed (most recent first)
        }
        return ta.localeCompare(tb);
      });

      if (filteredTasks.length === 0) {
        const emptyMsg = currentTab === 'upcoming' 
          ? { icon: 'check', title: 'All caught up!', sub: 'No more tasks for today' }
          : { icon: 'clock', title: 'Nothing here yet', sub: 'Completed tasks will appear here' };
        
        content.innerHTML = `
          <div class="empty">
            <div class="empty-icon" style="background: linear-gradient(135deg, ${currentTab === 'upcoming' ? 'var(--success), #34d399' : 'var(--blue), #60a5fa'})">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                ${emptyMsg.icon === 'check' 
                  ? '<path d="M9 12l2 2 4-4"></path><circle cx="12" cy="12" r="10"></circle>'
                  : '<circle cx="12" cy="12" r="10"></circle><path d="M12 6v6l4 2"></path>'
                }
              </svg>
            </div>
            <h3>${emptyMsg.title}</h3>
            <p>${emptyMsg.sub}</p>
          </div>
        `;
        return;
      }

      // Group tasks
      let html = '';
      
      if (currentTab === 'upcoming') {
        // Group by time periods
        const nowTasks = [];
        const soonTasks = [];
        const laterTasks = [];
        
        filteredTasks.forEach(t => {
          const taskMin = getTaskMinutes(t);
          if (taskMin <= nowMinutes + 30) {
            nowTasks.push(t);
          } else if (taskMin <= nowMinutes + 120) {
            soonTasks.push(t);
          } else {
            laterTasks.push(t);
          }
        });
        
        if (nowTasks.length > 0) {
          html += `<div class="section"><div class="section-title now">Now</div>`;
          nowTasks.forEach(t => html += taskHTML(t, false));
          html += `</div>`;
        }
        
        if (soonTasks.length > 0) {
          html += `<div class="section"><div class="section-title">Coming Up</div>`;
          soonTasks.forEach(t => html += taskHTML(t, false));
          html += `</div>`;
        }
        
        if (laterTasks.length > 0) {
          html += `<div class="section"><div class="section-title">Later</div>`;
          laterTasks.forEach(t => html += taskHTML(t, false));
          html += `</div>`;
        }
      } else {
        // Completed tab - group by status
        const doneTasks = filteredTasks.filter(t => t.completed || localDone.has(String(t.id)));
        const passedTasks = filteredTasks.filter(t => !t.completed && !localDone.has(String(t.id)));
        
        if (doneTasks.length > 0) {
          html += `<div class="section"><div class="section-title" style="color: var(--success)">Completed</div>`;
          doneTasks.forEach(t => html += taskHTML(t, true));
          html += `</div>`;
        }
        
        if (passedTasks.length > 0) {
          html += `<div class="section"><div class="section-title">Passed</div>`;
          passedTasks.forEach(t => html += taskHTML(t, true));
          html += `</div>`;
        }
      }

      content.innerHTML = html;
    }

    function taskHTML(t, isPast) {
      const taskId = String(t.id);
      const isDone = t.completed || localDone.has(taskId);
      const isSkipped = localSkipped.has(taskId);
      const skipInfo = localSkipped.get(taskId);
      
      // Determine category/type for styling
      let typeClass = '';
      const title = (t.title || '').toLowerCase();
      const cat = (t.category || '').toLowerCase();
      
      if (t.type === 'meeting' || title.includes('meeting') || title.includes('call')) {
        typeClass = 'meeting';
      } else if (title.includes('wake') || title.includes('breakfast') || title.includes('lunch') || title.includes('sleep') || title.includes('read') || cat.includes('routine')) {
        typeClass = 'routine';
      } else if (title.includes('work') || title.includes('structur') || cat.includes('work')) {
        typeClass = 'work';
      } else if (t.type === 'social') {
        typeClass = 'social';
      } else {
        typeClass = 'personal';
      }
      
      // Time display
      let timeStr = '';
      if (t.startTime) {
        timeStr = fmt(t.startTime);
        if (t.endTime) timeStr += ` - ${fmt(t.endTime)}`;
      }

      // Duration
      let durationStr = '';
      if (t.startTime && t.endTime) {
        const [sh, sm] = t.startTime.split(':').map(Number);
        const [eh, em] = t.endTime.split(':').map(Number);
        const mins = (eh * 60 + em) - (sh * 60 + sm);
        if (mins > 0) {
          if (mins >= 60) {
            const hrs = Math.floor(mins / 60);
            const m = mins % 60;
            durationStr = m > 0 ? `${hrs}h ${m}m` : `${hrs}h`;
          } else {
            durationStr = `${mins}m`;
          }
        }
      }

      const tagText = isSkipped ? 'Skipped' :
                     t.type === 'meeting' ? 'Meeting' : 
                     t.type === 'timeblock' ? 'Block' :
                     t.type === 'social' ? 'Social' :
                     t.category || 'Task';

      const classes = ['task', typeClass];
      if (isDone) classes.push('done');
      if (isSkipped) classes.push('skipped');
      if (isPast && !isDone && !isSkipped) classes.push('past');

      // Skip reason tooltip
      const skipReasonAttr = skipInfo?.reason ? `title="Reason: ${esc(skipInfo.reason)}"` : '';

      return `
        <div class="${classes.join(' ')}" data-id="${t.id}" data-type="${t.type}" ${skipReasonAttr}>
          <div class="chk" onclick="toggle('${t.id}', '${t.type}', event)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
              <path d="M20 6L9 17l-5-5"></path>
            </svg>
          </div>
          <div class="task-body" onclick="openApp()">
            <div class="task-row">
              <div class="task-title">${esc(t.title)}</div>
              <div class="task-time">${timeStr}</div>
            </div>
            <div class="task-meta">
              <span class="tag ${isSkipped ? 'skipped' : typeClass}">${tagText}</span>
              ${durationStr ? `<span class="duration">${durationStr}</span>` : ''}
              ${!isDone && !isSkipped ? `<button class="skip-btn" onclick="showSkipModal(${JSON.stringify(t).replace(/"/g, '&quot;')}, event)">Skip</button>` : ''}
              ${isSkipped && skipInfo?.reason ? `<span class="duration" title="${esc(skipInfo.reason)}">üìù</span>` : ''}
            </div>
          </div>
        </div>
      `;
    }

    function esc(s) {
      const d = document.createElement('div');
      d.textContent = s || '';
      return d.innerHTML;
    }

    function toggle(id, type, e) {
      e.stopPropagation();
      
      // Convert id to string for consistency
      const taskId = String(id);
      const wasDone = localDone.has(taskId);
      
      // Update local state immediately for responsive UI
      if (wasDone) {
        localDone.delete(taskId);
      } else {
        localDone.add(taskId);
      }
      
      // Re-render immediately
      render();
      
      // Send to main process
      if (wasDone) {
        ipcRenderer.send('quickview-action', { action: 'uncomplete', taskId: id, taskType: type });
      } else {
        ipcRenderer.send('quickview-action', { action: 'complete', taskId: id, taskType: type });
      }
    }

    function openApp() {
      ipcRenderer.send('quickview-action', { action: 'open-app' });
    }

    function closeView() {
      ipcRenderer.send('quickview-action', { action: 'close' });
    }

    // Skip functionality
    function showSkipModal(task, e) {
      e.stopPropagation();
      skipTargetTask = task;
      document.getElementById('skipTaskName').textContent = `Skip "${task.title}"?`;
      document.getElementById('skipReason').value = '';
      document.getElementById('skipModal').style.display = 'flex';
      document.getElementById('skipReason').focus();
    }

    function closeSkipModal() {
      document.getElementById('skipModal').style.display = 'none';
      skipTargetTask = null;
    }

    function confirmSkip() {
      if (!skipTargetTask) return;
      
      const reason = document.getElementById('skipReason').value.trim();
      const taskId = String(skipTargetTask.id);
      
      // Save to local state
      localSkipped.set(taskId, {
        reason: reason,
        skippedAt: new Date().toISOString(),
        task: skipTargetTask
      });
      
      // Send to main process
      ipcRenderer.send('quickview-action', { 
        action: 'skip', 
        taskId: skipTargetTask.id, 
        taskType: skipTargetTask.type,
        taskTitle: skipTargetTask.title,
        taskDate: skipTargetTask.date,
        reason: reason
      });
      
      closeSkipModal();
      render();
    }

    // Handle Enter key in skip modal
    document.getElementById('skipReason').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        confirmSkip();
      }
      if (e.key === 'Escape') {
        closeSkipModal();
      }
    });

    // Close modal on overlay click
    document.getElementById('skipModal').addEventListener('click', (e) => {
      if (e.target.id === 'skipModal') {
        closeSkipModal();
      }
    });
  </script>
</body>
</html>
